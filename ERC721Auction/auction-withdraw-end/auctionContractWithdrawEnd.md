このセクションでは、コントラクトを完成させ、アカウントが行った入札を引き出す関数とオークションを終了する関数を作成します。

### Withdraw
ローカル変数`bal`（バランス）を作成し、関数呼び出し者が最後の引き出し以降に行った入札の総額を保存します（75行目）。この値を`bal`に割り当てるには、関数呼び出し者のアドレスをキーとして入札マッピングにアクセスします。

次に、関数呼び出し者のアドレスの値を入札マッピングで0に設定します。これにより、入札の総額が引き出されるためです（76行目）。

次に、その金額のETHをコントラクトから関数呼び出し者に転送し、`Withdraw`イベントを発生させます（79行目）。

### End
関数呼び出し者がこの関数を実行してオークションを終了する前に、特定の条件が満たされているかどうかを確認する必要があります。オークションが開始されていること（83行目）、オークションの終了日が到達していること（84行目）、およびオークションがすでに終了していないこと（85行目）です。

オークションが終了したら、状態変数`ended`を`true`に設定します（87行目）。

誰かがオークションに参加し、NFTに入札したかどうかを確認します（88行目）。

入札があった場合、NFTをコントラクトから最高入札者に転送し（89行目）、最高入札者からコントラクトに送られたETHをNFTの売り手であるオークショニアのアドレスに転送します（90行目）。

誰もNFTに入札しなかった場合、NFTをオークショニアに返送します（92行目）。

最後に、`End`イベントを発生させます（95行目）。

## ⭐️ 課題

1. NFTコントラクトをデプロイします。Learnethの「Solidity NFTコース」で作成したNFTコントラクトを使用できます。

2. tokenId 0でNFTを鋳造します。

3. テスト目的で、`endAt`状態変数に割り当てられる値（54行目）を`7 days`から`5 minutes`に変更します。

4. このEnglishAuctionコントラクトをデプロイします。NFTコントラクトのアドレスを`_nft`パラメータとして、`_nftId`には0を、`_startingBid`には1を引数として使用します。

5. NFTコントラクトの`approve`関数を呼び出し、オークションコントラクトのアドレスを`to`パラメータとして、`tokenId`には0を引数として指定します。

6. オークションコントラクトの`start`関数を呼び出します。

7. アカウント1で2 Ether、アカウント2で3 Etherを入札します。`highestBidder`関数を呼び出すと、アカウント2のアドレスが返されるはずです。

8. アカウント1で`withdraw`関数を呼び出します。アカウント1の残高には、トランザクション手数料を差し引いた2 Etherが表示されるはずです。

9. 5分経過後に`end`関数を呼び出します。次に`ended`関数を呼び出すと、`true`を返すはずです。

NFTコントラクトで`ownerOf`関数をtokenId 0で呼び出すと、アカウント2のアドレスが返されるはずです。アカウント1の残高を確認すると、トランザクション手数料を差し引いた3 Etherが増加しているはずです。
